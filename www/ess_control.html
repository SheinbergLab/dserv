<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESS Control Panel</title>
    
    <!-- Component styles -->
    <link rel="stylesheet" href="css/ess_control.css">
    <link rel="stylesheet" href="css/eyetouch_visualizer.css">
    <link rel="stylesheet" href="css/mesh_dropdown.css">
    <link rel="stylesheet" href="css/TclTerminal.css">
</head>
<body class="ess-app">
    <div class="ess-container">
        <!-- Status Bar -->
        <div class="ess-status-bar">
            <h1>ESS Control</h1>
            <div class="ess-status-indicator" id="status-indicator"></div>
            <span class="ess-status-text" id="status-text">Connecting...</span>
            <div id="mesh-dropdown-container"></div>
            <div class="ess-status-spacer"></div>
            <span class="ess-system-state" id="system-state">--</span>
            <button onclick="reconnect()">Reconnect</button>
        </div>
        
        <!-- Main 3-Column Layout -->
        <div class="ess-grid">
            <!-- Left Column: ESS Control Panel -->
            <div class="ess-column ess-column-left">
                <div class="ess-panel">
                    <div class="ess-panel-header">
                        <span class="ess-panel-title">Experiment Control</span>
                    </div>
                    <div class="ess-panel-body">
                        <div id="ess-control-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Column: Eye/Touch + Input Controls -->
            <div class="ess-column ess-column-middle">
                <!-- Eye/Touch Visualizer (smaller, fixed size) -->
                <div class="ess-panel ess-panel-eyetouch">
                    <div class="ess-panel-header">
                        <span class="ess-panel-title">Eye/Touch Monitor</span>
                        <span class="ess-panel-status" id="eyetouch-stats"></span>
                    </div>
                    <div class="ess-panel-body ess-canvas-container">
                        <canvas id="eyetouch-canvas" class="ess-canvas" width="240" height="240"></canvas>
                    </div>
                </div>
                
                <!-- Input Controls (placeholder, flex to fill space) -->
                <div class="ess-panel ess-panel-inputs">
                    <div class="ess-panel-header">
                        <span class="ess-panel-title">Input Controls</span>
                    </div>
                    <div class="ess-panel-body">
                        <div id="input-controls-container">
                            <!-- Eye Tracker Settings -->
                            <div class="ess-input-section">
                                <div class="ess-input-section-title">Eye Tracker</div>
                                <div class="ess-input-row">
                                    <span class="ess-input-label">Center</span>
                                    <div class="ess-input-group">
                                        <label>h</label>
                                        <input type="number" id="eye-h-bias" value="0" min="-2000" max="2000" step="10">
                                        <label>v</label>
                                        <input type="number" id="eye-v-bias" value="0" min="-2000" max="2000" step="10">
                                    </div>
                                </div>
                                <div class="ess-input-row">
                                    <span class="ess-input-label">Gain</span>
                                    <div class="ess-input-group">
                                        <label>h</label>
                                        <input type="number" id="eye-h-gain" value="10.0" min="0.1" max="25" step="0.1">
                                        <label>v</label>
                                        <input type="number" id="eye-v-gain" value="10.0" min="0.1" max="25" step="0.1">
                                    </div>
                                </div>
                                <div class="ess-input-row">
                                    <span class="ess-input-label">Invert</span>
                                    <div class="ess-input-group">
                                        <label><input type="checkbox" id="eye-h-invert"> h</label>
                                        <label><input type="checkbox" id="eye-v-invert"> v</label>
                                        <button id="eye-recenter" class="ess-input-btn">Recenter</button>
                                    </div>
                                </div>
                            </div>
                            <!-- More input sections can be added here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Stimulus Display + Performance -->
            <div class="ess-column ess-column-right">
                <!-- Stimulus Display (fixed 512x320, 16:10) -->
                <div class="ess-panel ess-panel-stim">
                    <div class="ess-panel-header">
                        <span class="ess-panel-title">Stimulus Display</span>
                        <span class="ess-panel-status" id="stim-stats"></span>
                    </div>
                    <div class="ess-panel-body ess-canvas-container">
                        <canvas id="stim-canvas" class="ess-canvas" width="512" height="320"></canvas>
                    </div>
                </div>
                
                <!-- Performance (flex to fill remaining space) -->
                <div class="ess-panel ess-panel-perf">
                    <div class="ess-panel-header">
                        <span class="ess-panel-title">Performance</span>
                    </div>
                    <div class="ess-panel-body">
                        <div id="performance-container">
                            <div class="ess-perf-summary">
                                <div class="ess-perf-stat">
                                    <span class="ess-perf-label">Trial</span>
                                    <span class="ess-perf-value" id="perf-trial">--/--</span>
                                </div>
                                <div class="ess-perf-stat">
                                    <span class="ess-perf-label">% Correct</span>
                                    <span class="ess-perf-value" id="perf-correct">--%</span>
                                </div>
                                <div class="ess-perf-stat">
                                    <span class="ess-perf-label">% Complete</span>
                                    <span class="ess-perf-value" id="perf-complete">--%</span>
                                </div>
                            </div>
                            <div class="ess-perf-table-container">
                                <table id="perf-table" class="ess-perf-table">
                                    <thead>
                                        <tr><th>Metric</th><th>Value</th></tr>
                                    </thead>
                                    <tbody>
                                        <!-- Performance data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Panel (Console + Terminal) -->
        <div class="ess-bottom-panel" id="bottom-panel">
            <div class="ess-bottom-tabs">
                <button class="ess-bottom-tab active" data-tab="console" onclick="switchBottomTab('console')">
                    Console <span class="ess-console-count" id="error-count"></span>
                </button>
                <button class="ess-bottom-tab" data-tab="terminal" onclick="switchBottomTab('terminal')">
                    Terminal
                </button>
                <div class="ess-bottom-spacer"></div>
                <button class="ess-bottom-action" onclick="clearBottomPanel()">Clear</button>
                <button class="ess-bottom-action" onclick="toggleBottomPanel()">Toggle</button>
            </div>
            <div class="ess-bottom-content">
                <div class="ess-bottom-pane active" id="console-pane">
                    <div class="ess-console-body" id="console-output"></div>
                </div>
                <div class="ess-bottom-pane" id="terminal-pane">
                    <div id="tcl-terminal-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component scripts -->
    <script src="js/ws_manager.js"></script>
    <script src="js/DatapointManager.js"></script>
    <script src="js/TclParser.js"></script>
    <script src="js/GraphicsRenderer.js"></script>
    <script src="js/ESSControl.js"></script>
    <script src="js/EyeTouchVisualizer.js"></script>
    <script src="js/mesh_dropdown.js"></script>
    <script src="js/TclTerminal.js"></script>
    
    <!-- Main application script -->
    <script src="js/ess_app.js"></script>
    
    <!-- Eye settings handlers -->
    <script>
        class EyeSettings {
            constructor(dpManager) {
                this.dpManager = dpManager;
                this.elements = {
                    hBias: document.getElementById('eye-h-bias'),
                    vBias: document.getElementById('eye-v-bias'),
                    hGain: document.getElementById('eye-h-gain'),
                    vGain: document.getElementById('eye-v-gain'),
                    hInvert: document.getElementById('eye-h-invert'),
                    vInvert: document.getElementById('eye-v-invert'),
                    recenterBtn: document.getElementById('eye-recenter')
                };
                
                this.bindEvents();
                this.setupSubscriptions();
            }
            
            sendEmCommand(cmd) {
                try {
                    const conn = this.dpManager?.connection;
                    if (conn && conn.connected && conn.ws) {
                        conn.ws.send(`send em {${cmd}}`);
                    }
                } catch (error) {
                    console.error('Failed to send em command:', error);
                }
            }
            
            bindEvents() {
                this.elements.hBias?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param raw_center_h ${e.target.value}`);
                });
                
                this.elements.vBias?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param raw_center_v ${e.target.value}`);
                });
                
                this.elements.hGain?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param scale_h ${e.target.value}`);
                });
                
                this.elements.vGain?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param scale_v ${e.target.value}`);
                });
                
                this.elements.hInvert?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param invert_h ${e.target.checked ? 1 : 0}`);
                });
                
                this.elements.vInvert?.addEventListener('change', (e) => {
                    this.sendEmCommand(`::em::set_param invert_v ${e.target.checked ? 1 : 0}`);
                });
                
                this.elements.recenterBtn?.addEventListener('click', () => {
                    this.sendEmCommand('::em::set_current_as_center');
                });
            }
            
            setupSubscriptions() {
                this.dpManager?.subscribe('em/settings', (data) => {
                    this.updateFromSettings(data.value);
                });
            }
            
            updateFromSettings(settings) {
                if (!settings) return;
                
                let params = settings;
                if (typeof settings === 'string') {
                    params = this.parseTclDict(settings);
                }
                
                if (params.raw_center_h !== undefined && this.elements.hBias) {
                    this.elements.hBias.value = params.raw_center_h;
                }
                if (params.raw_center_v !== undefined && this.elements.vBias) {
                    this.elements.vBias.value = params.raw_center_v;
                }
                if (params.scale_h !== undefined && this.elements.hGain) {
                    this.elements.hGain.value = params.scale_h;
                }
                if (params.scale_v !== undefined && this.elements.vGain) {
                    this.elements.vGain.value = params.scale_v;
                }
                if (params.invert_h !== undefined && this.elements.hInvert) {
                    this.elements.hInvert.checked = !!parseInt(params.invert_h);
                }
                if (params.invert_v !== undefined && this.elements.vInvert) {
                    this.elements.vInvert.checked = !!parseInt(params.invert_v);
                }
            }
            
            parseTclDict(str) {
                const result = {};
                const parts = str.trim().split(/\s+/);
                for (let i = 0; i < parts.length - 1; i += 2) {
                    result[parts[i]] = parts[i + 1];
                }
                return result;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const checkDpManager = setInterval(() => {
                if (window.dpManager) {
                    clearInterval(checkDpManager);
                    window.eyeSettings = new EyeSettings(window.dpManager);
                }
            }, 100);
            setTimeout(() => clearInterval(checkDpManager), 5000);
        });
    </script>
</body>
</html>